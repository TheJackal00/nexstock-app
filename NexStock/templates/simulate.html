{% extends "layout.html" %}

{% block title %}
    Simulate
{% endblock %}

{% block main %}

<div class="container mx-auto p-4 max-w-4xl font-sans">
    <h1 class="text-4xl font-bold text-center text-gray-800 my-8">Run Simulation</h1>

    <div class="flex flex-col items-center space-y-4">
        <!-- First input field (existing) -->
        <div class="flex flex-col items-center">
            <label for="num-simulations" class="text-gray-700 font-semibold mb-2">
                Number of days to simulate:
            </label>
            <input
                type="number"
                id="num-simulations"
                value="30"
                min="1"
                class="w-24 text-center rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
            >
        </div>

        <!-- Second input field (lead time distribution type) -->
        <div class="flex flex-col items-center">
            <label for="lead-time-distribution" class="text-gray-700 font-semibold mb-2">
                Lead time distribution:
            </label>
            <select
                id="lead-time-distribution"
                class="w-32 text-center rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                onchange="updateLeadTimeLabels()"
            >
                <option value="normal">Normal</option>
                <option value="uniform">Uniform</option>
            </select>
        </div>

        <!-- Third input field (first lead time parameter) -->
        <div class="flex flex-col items-center">
            <label for="lead-time-param1" id="param1-label" class="text-gray-700 font-semibold mb-2">
                Average lead time (days):
            </label>
            <input
                type="number"
                id="lead-time-param1"
                value="7"
                min="0"
                step="0.1"
                class="w-24 text-center rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
            >
        </div>

        <!-- Fourth input field (second lead time parameter) -->
        <div class="flex flex-col items-center">
            <label for="lead-time-param2" id="param2-label" class="text-gray-700 font-semibold mb-2">
                Lead time std deviation:
            </label>
            <input
                type="number"
                id="lead-time-param2"
                value="2"
                min="0"
                step="0.1"
                class="w-24 text-center rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
            >
        </div>

        <button
            id="run-button"
            onclick="runSimulation()"
            class="bg-blue-600 hover:bg-blue-700 text-black font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
        >
            Run Simulation
        </button>

        <!-- Loading indicator -->
        <div
            id="loading-spinner"
            class="mt-8 hidden animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"
        ></div>
    </div>

    <div id="results-container" class="mt-12 space-y-8">
        <!-- Simulation results will be displayed here -->
    </div>
</div>

<script>
    const MAX_SIMULATIONS = 1000; // Reduced from 1300 for better performance
    const MAX_LEAD_TIME_PARAM = 365; // Maximum lead time parameter value

    // Function to update labels based on selected distribution
    function updateLeadTimeLabels() {
        const distributionSelect = document.getElementById('lead-time-distribution');
        const param1Label = document.getElementById('param1-label');
        const param2Label = document.getElementById('param2-label');
        const param1Input = document.getElementById('lead-time-param1');
        const param2Input = document.getElementById('lead-time-param2');

        if (distributionSelect.value === 'normal') {
            param1Label.textContent = 'Average lead time (days):';
            param2Label.textContent = 'Lead time std deviation:';
            param1Input.value = '7';
            param2Input.value = '2';
            param1Input.min = '0';
            param2Input.min = '0';
        } else if (distributionSelect.value === 'uniform') {
            param1Label.textContent = 'Floor lead time (days):';
            param2Label.textContent = 'Ceiling lead time (days):';
            param1Input.value = '5';
            param2Input.value = '10';
            param1Input.min = '0';
            param2Input.min = '0';
        }
    }

    async function runSimulation() {
        const button = document.getElementById('run-button');
        const resultsContainer = document.getElementById('results-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const numSimulationsInput = document.getElementById('num-simulations');
        const distributionSelect = document.getElementById('lead-time-distribution');
        const param1Input = document.getElementById('lead-time-param1');
        const param2Input = document.getElementById('lead-time-param2');

        const numSimulations = parseInt(numSimulationsInput.value, 10);
        const distribution = distributionSelect.value;
        const param1 = parseFloat(param1Input.value);
        const param2 = parseFloat(param2Input.value);

        // Validate first input (number of days)
        if (isNaN(numSimulations) || numSimulations <= 0) {
            showError('Please enter a valid number of days (greater than 0).');
            return;
        }

        // Validate parameters based on distribution type
        if (distribution === 'normal') {
            if (isNaN(param1) || param1 <= 0) {
                showError('Please enter a valid average lead time (greater than 0).');
                return;
            }
            if (isNaN(param2) || param2 < 0) {
                showError('Please enter a valid standard deviation (0 or greater).');
                return;
            }
        } else if (distribution === 'uniform') {
            if (isNaN(param1) || param1 < 0) {
                showError('Please enter a valid floor lead time (0 or greater).');
                return;
            }
            if (isNaN(param2) || param2 < 0) {
                showError('Please enter a valid ceiling lead time (0 or greater).');
                return;
            }
            if (param2 <= param1) {
                showError('Ceiling lead time must be greater than floor lead time.');
                return;
            }
        }

        // Check maximum limits
        if (numSimulations > MAX_SIMULATIONS) {
            showError(`The maximum allowed days is ${MAX_SIMULATIONS}.`);
            return;
        }

        if (param1 > MAX_LEAD_TIME_PARAM || param2 > MAX_LEAD_TIME_PARAM) {
            showError(`Lead time parameters cannot exceed ${MAX_LEAD_TIME_PARAM} days.`);
            return;
        }

        // Show loading spinner and disable button
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        loadingSpinner.classList.remove('hidden');
        resultsContainer.innerHTML = ''; // Clear previous results

        try {
            // Send a POST request to the Flask endpoint with all parameters
            const response = await fetch('/run_simulation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    size: numSimulations,
                    lead_time_distribution: distribution,
                    lead_time_param1: param1,
                    lead_time_param2: param2
                })
            });

            const data = await response.json();

            // Debug: log the response to see what we're getting
            console.log('Server response:', data);
            console.log('Results array:', data.results);
            console.log('First result item:', data.results ? data.results[0] : 'No results');
            console.log('First result JSON:', data.results ? JSON.stringify(data.results[0], null, 2) : 'No results');

            if (!response.ok) {
                // Handle error responses
                const errorMsg = data.error || `Server responded with status: ${response.status}`;
                throw new Error(errorMsg);
            }

            // Handle the improved response format
            if (data.status === 'success' && data.results) {
                displayResults(data.results, numSimulations, distribution, param1, param2);
                showSuccessMessage(data.message, data.total_records || data.results.length);
            } else if (Array.isArray(data) && data.length > 0) {
                // Fallback for old response format (direct array)
                displayResults(data, numSimulations, distribution, param1, param2);
            } else if (Array.isArray(data.results) && data.results.length > 0) {
                // Handle case where results is nested
                displayResults(data.results, numSimulations, distribution, param1, param2);
            } else {
                showError('No simulation data returned. Please check the database.');
            }

        } catch (error) {
            console.error('Error during simulation:', error);
            showError(`An error occurred: ${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    function displayResults(results, numSimulations, distribution, param1, param2) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = ""; // Clear previous results

        // Format parameter display based on distribution type
        let param1Label, param2Label;
        if (distribution === 'normal') {
            param1Label = 'Mean';
            param2Label = 'Std Dev';
        } else {
            param1Label = 'Floor';
            param2Label = 'Ceiling';
        }

        results.forEach(item => {
            const card = document.createElement('div');
            card.className = "bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200";

            card.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-2">
                    SKU: ${item.SKU} - ${item.product_name || ''}
                </h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <p class="text-gray-600">
                        Avg Initial Stock: <span class="font-medium">${Number(item.initial_stock_avg).toFixed(2)}</span>
                    </p>
                    <p class="text-gray-600">
                        Avg Volume: <span class="font-medium">${Number(item.a_volume_avg).toFixed(2)}</span>
                    </p>
                    <p class="text-gray-600">
                        Volume Std Dev: <span class="font-medium">${Number(item.sd_volume_avg).toFixed(2)}</span>
                    </p>
                    <p class="text-gray-600">
                        Simulation Days: <span class="font-medium">${item.simulation_days}</span>
                    </p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <p class="text-gray-600">
                        Lead Time Dist: <span class="font-medium capitalize">${distribution}</span>
                    </p>
                    <p class="text-gray-600">
                        ${param1Label}: <span class="font-medium">${param1}</span>
                    </p>
                    <p class="text-gray-600">
                        ${param2Label}: <span class="font-medium">${param2}</span>
                    </p>
                </div>
                <div>
                    <div class="h5 fw-bold text-primary mb-2">Simulation Output (10 runs)</div>
                    <div class="row text-center mb-2 py-2 bg-light rounded">
                        <div class="col-4 border-end">
                            <div class="small text-secondary">Min Demand</div>
                            <div class="fw-bold text-dark">${item.min_demand}</div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="small text-secondary">Avg Demand</div>
                            <div class="fw-bold text-dark">${typeof item.avg_demand === 'number' ? item.avg_demand.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-secondary">Max Demand</div>
                            <div class="fw-bold text-dark">${item.max_demand}</div>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }

    function showError(message) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-600 text-center font-medium">${message}</p>
            </div>
        `;
    }

    function showSuccessMessage(message, totalRecords) {
        const resultsContainer = document.getElementById('results-container');
        // Create the success message div
        const successDiv = document.createElement('div');
        successDiv.className = "bg-green-50 border border-green-200 rounded-lg p-4 mb-6";
        
        // Number of simulated days
        const numDays = parseInt(document.getElementById('num-simulations').value, 10);
        
        successDiv.innerHTML = `
            <p class="text-green-700 text-center font-medium">
                ✅ ${message}
            </p>
            <p class="text-green-600 text-center text-sm mt-1">
                Processed: ${totalRecords} SKUs × ${numDays} days × 10 iterations = ${totalRecords * numDays * 10} records
            </p>
        `;
        // Insert the message at the top, before the results
        resultsContainer.prepend(successDiv);
    }

    // Optional: Add keyboard event listeners for better UX
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    runSimulation();
                }
            });
        });
    });
</script>

{% endblock %}
